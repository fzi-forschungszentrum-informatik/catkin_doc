#!/usr/bin/env python
"""catkin_doc helps creating documentations for catkin packages"""

import catkin_doc.cmakeparser
import catkin_doc.pkghandler
import catkin_doc.nodeconverter
import catkin_doc.rstparser
import catkin_doc.mdparser
import catkin_doc.nodecomparator
import os
import sys


def main():
    """
    This function will search for python and cpp nodes.
    than for each of this nodes it will search for existing docu
    if no docu is found it will ask for path to docu
    than parse each docu file and compare to previously generated nodes
    at last the merged nodes are written to given file format
    """
    package_path = sys.argv[1]
    file_format = sys.argv[2]
    if len(sys.argv) > 3:
      docu_file = sys.argv[3]
    else:
        docu_file = ""
    cpp_handler = catkin_doc.cmakeparser.CmakeListParser(package_path)
    py_handler = catkin_doc.pkghandler.PkgHandler(package_path)
    nodeconverter = catkin_doc.nodeconverter.NodeConverter()
    docu_list, docu_file = catkin_doc.pkghandler.PkgHandler.find_docu(package_path, docu_file)
    new_docu_file = "temp_file." + file_format
    pathlist = package_path.split("/")
    if pathlist[-1] != "":
        pkg_name = pathlist[-1]
    else:
        pkg_name = pathlist[-2]

    for parser in cpp_handler.parser:
        found_docu = False
        if parser.node.filename in docu_list and ".rst" in docu_file :
            found_docu = True
            rst_parser = catkin_doc.rstparser.RstParser(parser.node.filename, docu_file, docu_list[parser.node.filename])
            comp = catkin_doc.nodecomparator.NodeComparator(parser.node, rst_parser.node)
            nodeconverter.convert_to_file(comp.merged_node, file_format, new_docu_file)
        elif parser.node.filename in docu_list and ".md" in docu_file:
            found_docu = True
            md_parser = catkin_doc.mdparser.MdParser(parser.node.filename, docu_file, docu_list[parser.node.filename])
            comp = catkin_doc.nodecomparator.NodeComparator(parser.node, md_parser.node)
            nodeconverter.convert_to_file(comp.merged_node, file_format, new_docu_file)
        if not found_docu:
            print("Did not found matching docu for node " + parser.node.filename)
            nodeconverter.convert_to_file(parser.node, file_format, new_docu_file)


    for parser in py_handler.parser:
        found_docu = False
        if parser.node.filename in docu_list and ".rst" in docu_file:
            found_docu = True
            rst_parser = catkin_doc.rstparser.RstParser(parser.node.filename, docu_file, docu_list[parser.node.filename])
            comp = catkin_doc.nodecomparator.NodeComparator(parser.node, rst_parser.node)
            nodeconverter.convert_to_file(comp.merged_node, file_format, new_docu_file)
        elif parser.node.filename in docu_list and ".md" in docu_file:
            found_docu =True
            md_parser = catkin_doc.mdparser.MdParser(parser.node.filename, docu_file, docu_list[parser.node.filename])
            comp = catkin_doc.nodecomparator.NodeComparator(parser.node, md_parser.node)
            nodeconverter.convert_to_file(comp.merged_node, file_format, new_docu_file)
        if not found_docu:
            print("Did not found matching docu for node " + parser.node.filename)
            nodeconverter.convert_to_file(parser.node, file_format, new_docu_file)
    if os.path.isfile(new_docu_file):
        os.rename(new_docu_file, (pkg_name + "." + file_format))

if __name__ == "__main__":
    main()
